import socket
import sys

# Runs an internal TCP service on localhost that retrieves passwords
class TCPService():
    def __init__(self, port):
        self.port = port
        self.password_file = "elise_passwords.txt"

    def run(self):
        # Written referencing Python documentation from https://pymotw.com/2/socket/tcp.html

        # Create the TCP socket
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        # Bind the TCP socket to the port given
        server_address = ('localhost', self.port)
        print(f"Server starting up on port {self.port}...")
        sock.bind(server_address)

        # Listen for incoming connections
        sock.listen(1)
        print(f"Server is now listening on port {self.port}...")

        # Wait for a connection
        while True:
            print(f"Waiting for a connection...")
            connection, client_address = sock.accept()

            try:
                print(f"Connection from {client_address}")

                # Receive the data and print the data
                data = connection.recv(2014)
                if data:
                    print(f"Received {data}")
                else:
                    print(f"Received no data")

                # Get passwords from password file
                f = open(self.password_file)
                passwords = ""
                for password in f:
                    passwords += password + "\n"

                print(f"Sending {passwords}")

                # Convert passwords to bytes and send them
                connection.sendall(bytes(passwords))

            finally:
                # Clean up the connection
                connection.close()

if __name__ == "__main__":
    # Set port number from arguments, otherwise default to 8080
    if len(sys.argv) > 1:
        port = sys.argv[1]
    else:
        port = 8080

    tcpService = TCPService(port)
    tcpService.run()
    sys.exit(0)
